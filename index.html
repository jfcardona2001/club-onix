<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrador - Club √ìnix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;margin:20px;}
input,select,button{padding:5px;margin:5px 0;}
table{border-collapse:collapse;width:100%;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:left;}
.pago-pendiente{background-color:#f8d7da;color:#721c24;font-weight:bold;}
.pago-pagado{background-color:#d4edda;color:#155724;font-weight:bold;}
.delete-btn{background:#dc3545;color:white;border:none;border-radius:3px;padding:5px;}
#panel{display:none;}
#error{color:red;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>Club √ìnix - Panel de Administrador</h1>

<div id="loginPanel">
  <h2>Iniciar sesi√≥n</h2>
  <input id="loginEmail" type="email" placeholder="Correo electr√≥nico"><br>
  <input id="loginPassword" type="password" placeholder="Contrase√±a"><br>
  <button onclick="login()">Iniciar sesi√≥n</button>
  <p id="error"></p>
</div>

<div id="panel">
  <h2>Registrar / Editar deportista</h2>
  <input id="nombre" placeholder="Nombre del deportista">
  <input id="categoria" placeholder="Categor√≠a"><br>
  <h3>Datos del acudiente</h3>
  <input id="acudienteNombre" placeholder="Nombre del acudiente">
  <input id="acudienteTelefono" placeholder="Tel√©fono">
  <input id="acudienteCorreo" type="email" placeholder="Correo electr√≥nico"><br>
  <label>Sede:</label>
  <select id="sede">
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select><br>
  <button id="btnGuardar" onclick="agregarDeportista()">Agregar deportista</button>

  <h2>Filtros</h2>
  <label>Nombre: </label><input id="busquedaNombre" oninput="mostrar()"><br>
  <label>Sede: </label>
  <select id="filtroSede" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select><br>
  <label>Mes de pago: </label>
  <select id="filtroMes" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="1">Enero</option>
    <option value="2">Febrero</option>
    <option value="3">Marzo</option>
    <option value="4">Abril</option>
    <option value="5">Mayo</option>
    <option value="6">Junio</option>
    <option value="7">Julio</option>
    <option value="8">Agosto</option>
    <option value="9">Septiembre</option>
    <option value="10">Octubre</option>
    <option value="11">Noviembre</option>
    <option value="12">Diciembre</option>
  </select><br>

  <h2>Tabla de deportistas</h2>
  <table id="tablaDeportistas">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Categor√≠a</th>
        <th>Pago</th>
        <th>Mes</th>
        <th>Sede</th>
        <th>Acudiente</th>
        <th>Tel√©fono</th>
        <th>Correo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Registrar pago</h2>
  <input id="pagoNombre" placeholder="Nombre del deportista">
  <input id="monto" type="number" placeholder="Monto (COP)">
  <button onclick="registrarPago()">Registrar pago</button>

  <br><br>
  <button onclick="exportarPDF()">Exportar PDF</button>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDIFkhozwB5W7NYdjJlvH-EZvPlvFsOz3E",
  authDomain: "club-deportivo-de-volley-onix.firebaseapp.com",
  projectId: "club-deportivo-de-volley-onix",
  storageBucket: "club-deportivo-de-volley-onix.firebasestorage.app",
  messagingSenderId: "378193996380",
  appId: "1:378193996380:web:12c4c1cf27499e224a9499",
  measurementId: "G-Y8DL77DH3J"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let editarId = null;

// ===== AUTENTICACI√ìN =====
function login(){
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const error = document.getElementById("error");
  auth.signInWithEmailAndPassword(email,password)
    .then(()=>{ error.innerText=""; })
    .catch(()=>{ error.innerText="Correo o contrase√±a incorrectos"; });
}

function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("loginPanel").style.display="none";
    document.getElementById("panel").style.display="block";
    mostrar();
  }else{
    document.getElementById("loginPanel").style.display="block";
    document.getElementById("panel").style.display="none";
  }
});

// ===== FUNCIONES PRINCIPALES =====
function limpiarFormulario(){
  document.getElementById("nombre").value="";
  document.getElementById("categoria").value="";
  document.getElementById("acudienteNombre").value="";
  document.getElementById("acudienteTelefono").value="";
  document.getElementById("acudienteCorreo").value="";
  document.getElementById("sede").value="Pereira";
  document.getElementById("btnGuardar").innerText="Agregar deportista";
  editarId = null;
}

function agregarDeportista(){
  const nombre=document.getElementById("nombre").value;
  const categoria=document.getElementById("categoria").value;
  const acudienteNombre=document.getElementById("acudienteNombre").value;
  const acudienteTelefono=document.getElementById("acudienteTelefono").value;
  const acudienteCorreo=document.getElementById("acudienteCorreo").value;
  const sede = document.getElementById("sede").value;
  if(!nombre) return;

  if(!editarId){
    db.collection("deportistas").add({
      nombre,
      categoria,
      pago:"Pendiente",
      mesPago:"",
      sede,
      acudiente:{nombre:acudienteNombre,telefono:acudienteTelefono,correo:acudienteCorreo}
    }).then(limpiarFormulario).then(mostrar);
  }else{
    db.collection("deportistas").doc(editarId).get().then(docSnap=>{
      const d = docSnap.data();
      db.collection("deportistas").doc(editarId).update({
        nombre,
        categoria,
        sede,
        acudiente:{nombre:acudienteNombre,telefono:acudienteTelefono,correo:acudienteCorreo},
        pago: d.pago,
        mesPago: d.mesPago
      }).then(limpiarFormulario).then(mostrar);
    });
  }
}

function editarDeportista(id){
  db.collection("deportistas").doc(id).get().then(docSnap=>{
    const d = docSnap.data();
    document.getElementById("nombre").value = d.nombre;
    document.getElementById("categoria").value = d.categoria;
    document.getElementById("acudienteNombre").value = d.acudiente?.nombre||"";
    document.getElementById("acudienteTelefono").value = d.acudiente?.telefono||"";
    document.getElementById("acudienteCorreo").value = d.acudiente?.correo||"";
    document.getElementById("sede").value = d.sede||"Pereira";
    editarId = id;
    document.getElementById("btnGuardar").innerText="Guardar cambios";
  });
}

function borrarDeportista(id){
  if(confirm("¬øSeguro que deseas eliminar este deportista?")){
    db.collection("deportistas").doc(id).delete().then(mostrar);
  }
}

function cambiarEstado(id,estado){
  const mesActual = new Date().getMonth()+1;
  let nuevoPago = estado==="Pagado" ? "Pagado" : "Pendiente";
  let nuevoMes = estado==="Pagado" ? mesActual : "";
  db.collection("deportistas").doc(id).update({pago:nuevoPago, mesPago:nuevoMes}).then(mostrar);
}

function registrarPago(){
  const nombre = document.getElementById("pagoNombre").value;
  const mesActual = new Date().getMonth() + 1;
  db.collection("deportistas").where("nombre","==",nombre).get().then(snapshot=>{
    snapshot.forEach(docu=>{
      docu.ref.update({pago:"Pagado", mesPago:mesActual});
    });
    mostrar();
  });
}

function mostrar(){
  const filtroSede=document.getElementById("filtroSede").value;
  const filtroMes=document.getElementById("filtroMes").value;
  const busqueda=document.getElementById("busquedaNombre").value.toLowerCase();

  const tbody = document.querySelector("#tablaDeportistas tbody");
  tbody.innerHTML="";

  db.collection("deportistas").get().then(snapshot=>{
    snapshot.forEach(docu=>{
      const d = docu.data();
      const id = docu.id;
      if(filtroSede!=="todos" && d.sede!==filtroSede) return;
      if(filtroMes!=="todos" && d.mesPago != filtroMes) return;
      if(!d.nombre.toLowerCase().includes(busqueda)) return;

      const clasePago = d.pago==="Pagado" ? "pago-pagado" : "pago-pendiente";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.nombre}</td>
        <td>${d.categoria}</td>
        <td class="${clasePago}">${d.pago}</td>
        <td>${d.mesPago || "-"}</td>
        <td>${d.sede}</td>
        <td>${d.acudiente?.nombre || "-"}</td>
        <td>${d.acudiente?.telefono || "-"}</td>
        <td>${d.acudiente?.correo || "-"}</td>
        <td>
          <button onclick="cambiarEstado('${id}','Pagado')">Pagado</button>
          <button onclick="cambiarEstado('${id}','Pendiente')">Pendiente</button>
          <button onclick="editarDeportista('${id}')">‚úèÔ∏è Editar</button>
          <button class="delete-btn" onclick="borrarDeportista('${id}')">üóëÔ∏è Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;
  db.collection("deportistas").orderBy("categoria").get().then(snapshot=>{
    snapshot.forEach(docu=>{
      const d = docu.data();
      doc.text(`Nombre: ${d.nombre}`,10,y); y+=6;
      doc.text(`Categor√≠a: ${d.categoria}`,10,y); y+=6;
      doc.text(`Acudiente: ${d.acudiente?.nombre||"-"}`,10,y); y+=6;
      doc.text(`Tel√©fono: ${d.acudiente?.telefono||"-"}`,10,y); y+=6;
      doc.text(`Correo: ${d.acudiente?.correo||"-"}`,10,y); y+=6;
      doc.text(`Sede: ${d.sede}`,10,y); y+=6;
      doc.text(`Pago: ${d.pago}`,10,y); y+=8;
      if(y>270){ doc.addPage(); y=10; }
    });
    doc.save("Deportistas.pdf");
  });
}
</script>

</body>
</html>
