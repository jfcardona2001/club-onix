<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrador - Club √ìnix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Estilos -->
<link rel="stylesheet" href="css/estilos.css">

<!-- Librer√≠a jsPDF para generar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<h1>Club √ìnix - Panel de Administrador</h1>

<div id="loginPanel">
  <h2>Iniciar sesi√≥n</h2>
  <input id="loginEmail" type="email" placeholder="Correo electr√≥nico"><br>
  <input id="loginPassword" type="password" placeholder="Contrase√±a"><br>
  <button onclick="login()">Iniciar sesi√≥n</button>
  <p id="error"></p>
</div>

<div id="panel">
  <h2>Registrar deportista</h2>
  <input id="nombre" placeholder="Nombre del deportista">
  <input id="categoria" placeholder="Categor√≠a">
  <select id="sede">
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select><br>

  <h3>Datos del acudiente</h3>
  <input id="acudienteNombre" placeholder="Nombre del acudiente">
  <input id="acudienteTelefono" placeholder="Tel√©fono">
  <input id="acudienteCorreo" type="email" placeholder="Correo electr√≥nico"><br>
  <button id="btnGuardar" onclick="agregarDeportista()">Agregar deportista</button>

  <h2>Lista de deportistas</h2>
  <label>Filtrar por pago: </label>
  <select id="filtroPago" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="pendiente">Pendientes</option>
    <option value="pagado">Pagados</option>
  </select>
  <label>Filtrar por sede: </label>
  <select id="filtroSede" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select>
  <br>
  <label>Buscar por nombre: </label>
  <input id="busquedaNombre" type="text" placeholder="Escribe el nombre" oninput="mostrar()">
  <ul id="lista"></ul>

  <h2>Registrar pago</h2>
  <input id="pagoNombre" placeholder="Nombre del deportista">
  <input id="monto" type="number" placeholder="Monto (COP)">
  <button onclick="registrarPago()">Registrar pago</button>

  <br><br>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDIFkhozwB5W7NYdjJlvH-EZvPlvFsOz3E",
    authDomain: "club-deportivo-de-volley-onix.firebaseapp.com",
    projectId: "club-deportivo-de-volley-onix",
    storageBucket: "club-deportivo-de-volley-onix.firebasestorage.app",
    messagingSenderId: "378193996380",
    appId: "1:378193996380:web:12c4c1cf27499e224a9499",
    measurementId: "G-Y8DL77DH3J"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let editarId = null;

  // ===== AUTENTICACI√ìN =====
  async function login(){
    const email=document.getElementById("loginEmail").value;
    const password=document.getElementById("loginPassword").value;
    const error=document.getElementById("error");
    try{
      await signInWithEmailAndPassword(auth,email,password);
      error.innerText="";
    }catch(e){
      error.innerText="Correo o contrase√±a incorrectos";
    }
  }

  function logout(){
    signOut(auth);
  }

  onAuthStateChanged(auth,user=>{
    if(user){
      document.getElementById("loginPanel").style.display="none";
      document.getElementById("panel").style.display="block";
      mostrar();
    }else{
      document.getElementById("loginPanel").style.display="block";
      document.getElementById("panel").style.display="none";
    }
  });

  // ===== FUNCIONES PRINCIPALES =====
  function limpiarFormulario(){
    document.getElementById("nombre").value="";
    document.getElementById("categoria").value="";
    document.getElementById("sede").value="Pereira";
    document.getElementById("acudienteNombre").value="";
    document.getElementById("acudienteTelefono").value="";
    document.getElementById("acudienteCorreo").value="";
    document.getElementById("btnGuardar").innerText="Agregar deportista";
    editarId = null;
  }

  async function agregarDeportista(){
    const nombre=document.getElementById("nombre").value;
    const categoria=document.getElementById("categoria").value;
    const sede=document.getElementById("sede").value;
    const acudienteNombre=document.getElementById("acudienteNombre").value;
    const acudienteTelefono=document.getElementById("acudienteTelefono").value;
    const acudienteCorreo=document.getElementById("acudienteCorreo").value;
    if(!nombre) return;

    let pagoAnterior = "Pendiente";
    if(editarId){
      const docSnap = await getDoc(doc(db,"deportistas",editarId));
      pagoAnterior = docSnap.data().pago || "Pendiente";
    }

    const deportistaData={
      nombre,
      categoria,
      sede,
      pago: pagoAnterior,
      acudiente:{nombre:acudienteNombre,telefono:acudienteTelefono,correo:acudienteCorreo}
    };

    if(!editarId){
      await addDoc(collection(db,"deportistas"),deportistaData);
    }else{
      await setDoc(doc(db,"deportistas",editarId),deportistaData);
    }
    mostrar();
    limpiarFormulario();
  }

  async function editarDeportista(id){
    const docSnap = await getDoc(doc(db,"deportistas",id));
    const d = docSnap.data();
    document.getElementById("nombre").value=d.nombre;
    document.getElementById("categoria").value=d.categoria;
    document.getElementById("sede").value=d.sede || "Pereira";
    document.getElementById("acudienteNombre").value=d.acudiente?.nombre||"";
    document.getElementById("acudienteTelefono").value=d.acudiente?.telefono||"";
    document.getElementById("acudienteCorreo").value=d.acudiente?.correo||"";
    editarId=id;
    document.getElementById("btnGuardar").innerText="Guardar cambios";
  }

  async function borrarDeportista(id){
    if(confirm("¬øSeguro que deseas eliminar este deportista?")){
      await deleteDoc(doc(db,"deportistas",id));
      mostrar();
    }
  }

  async function registrarPago(){
    const nombre=document.getElementById("pagoNombre").value;
    const monto=document.getElementById("monto").value;
    const q=query(collection(db,"deportistas"),where("nombre","==",nombre));
    const querySnapshot = await getDocs(q);
    querySnapshot.forEach(async docu => {
      await updateDoc(doc(db,"deportistas",docu.id),{pago:"Pagado $ "+monto});
      generarFactura(docu); // Genera PDF
    });
    mostrar();
  }

  function enviarWhatsApp(nombre,pago){
    const url=`https://wa.me/?text=${encodeURIComponent(`Hola ${nombre}, tu estado de pago es: ${pago}. Club √ìnix`)}`;
    window.open(url,"_blank");
  }

  function enviarCorreo(nombre,pago){
    const url=`https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent("Estado de pago - Club √ìnix")}&body=${encodeURIComponent(`Hola ${nombre}, tu estado de pago es: ${pago}.`)}`;
    window.open(url,"_blank");
  }

  async function mostrar(){
    const lista=document.getElementById("lista");
    const filtroPago=document.getElementById("filtroPago").value;
    const filtroSede=document.getElementById("filtroSede").value;
    const busqueda=document.getElementById("busquedaNombre").value.toLowerCase();
    lista.innerHTML="";
    const querySnapshot = await getDocs(collection(db,"deportistas"));
    querySnapshot.forEach(docu=>{
      const d=docu.data(); 
      const id=docu.id;
      const clasePago=d.pago.startsWith("Pagado")?"pago-pagado":"pago-pendiente";
      if(filtroPago==="pendiente" && d.pago.startsWith("Pagado")) return;
      if(filtroPago==="pagado" && d.pago.startsWith("Pendiente")) return;
      if(filtroSede!=="todos" && d.sede!==filtroSede) return;
      if(!d.nombre.toLowerCase().includes(busqueda)) return;

      const li=document.createElement("li");
      li.className="deportista-card";
      li.innerHTML=`
        <strong>${d.nombre}</strong> - ${d.categoria} - ${d.sede} - <span class="${clasePago}">${d.pago}</span><br>
        <small>üë§ <strong>Acudiente:</strong> ${d.acudiente?.nombre||"-"}<br>
        üìû <strong>Tel√©fono:</strong> ${d.acudiente?.telefono||"-"}<br>
        ‚úâÔ∏è <strong>Correo:</strong> ${d.acudiente?.correo||"-"}</small>
        <button onclick="enviarWhatsApp('${d.nombre}','${d.pago}')">üì≤ WhatsApp</button>
        <button onclick="enviarCorreo('${d.nombre}','${d.pago}')">‚úâÔ∏è Gmail</button>
        <button onclick="editarDeportista('${id}')">‚úèÔ∏è Editar</button>
        <button class="delete-btn" onclick="borrarDeportista('${id}')">üóëÔ∏è Eliminar</button>
      `;
      lista.appendChild(li);
    });
  }

  // ===== GENERAR FACTURA PDF Y OPCI√ìN WHATSAPP =====
  async function generarFactura(docu){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const d = docu.data();

    doc.setFontSize(18);
    doc.text("Factura de Pago - Club √ìnix", 20, 20);
    doc.setFontSize(12);
    doc.text(`Nombre del Deportista: ${d.nombre}`, 20, 40);
    doc.text(`Categor√≠a: ${d.categoria}`, 20, 50);
    doc.text(`Sede: ${d.sede || "-"}`, 20, 60);
    doc.text(`Estado de Pago: ${d.pago}`, 20, 70);
    if(d.pago.startsWith("Pagado")){
      doc.text(`Monto Pagado: ${d.pago.replace("Pagado $ ","$")}`, 20, 80);
    }
    doc.text(`Acudiente: ${d.acudiente?.nombre || "-"}`, 20, 100);
    doc.text(`Tel√©fono: ${d.acudiente?.telefono || "-"}`, 20, 110);
    doc.text(`Correo: ${d.acudiente?.correo || "-"}`, 20, 120);

    // Generar Blob para WhatsApp
    const pdfBlob = doc.output("blob");

    // Descargar PDF local
    doc.save(`Factura_${d.nombre.replace(/ /g,"_")}.pdf`);

    // Crear enlace de WhatsApp
    const waUrl = `https://wa.me/?text=${encodeURIComponent(`Hola ${d.acudiente?.nombre || ""}, tu factura del pago de ${d.nombre} est√° lista.`)}`;
    const a = document.createElement("a");
    a.href = waUrl;
    a.target = "_blank";
    a.click();
  }

</script>

</body>
</html>
