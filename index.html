<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrador - Club Ã“nix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ===== RESET ===== */
* {margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif;}
body {background: linear-gradient(to right, #f2f2f2, #e6f0ff); padding:20px;}

/* ===== CABECERA ===== */
h1,h2,h3 {color:#003366; margin-bottom:10px;}
h1 {text-align:center; margin-bottom:30px;}
h2,h3 {margin-top:20px;}

/* ===== INPUTS Y BOTONES ===== */
input, select, button {padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; font-size:14px;}
input:focus, select:focus {outline:none; border-color:#0066cc;}
button {cursor:pointer; background:#0066cc; color:white; border:none; transition:0.3s;}
button:hover {background:#004c99;}
.delete-btn {background:#dc3545; transition:0.3s;}
.delete-btn:hover {background:#a3001a;}

/* ===== PANEL ===== */
#panel, #loginPanel {max-width:900px; margin:0 auto; padding:20px; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
#error {color:red; margin-top:10px;}

/* ===== LISTA DE DEPORTISTAS ===== */
ul {list-style:none; padding:0; margin-top:15px;}
.deportista-card {border:1px solid #ccc; padding:15px; margin-bottom:10px; border-radius:8px; background:#f9f9f9; display:flex; flex-direction:column;}
.deportista-card span {font-weight:bold;}
.pago-pendiente {color:red;}
.pago-pagado {color:green;}

/* ===== BOTONES TARJETA ===== */
.deportista-card button {margin-top:8px; padding:6px 10px; font-size:13px;}

/* ===== FORMULARIOS FLEX ===== */
#panel input[type="text"], #panel input[type="email"], #panel input[type="number"], #panel select {width:100%;}
#panel .flex {display:flex; gap:10px; flex-wrap:wrap;}
#panel .flex > * {flex:1;}

/* ===== FILTROS ===== */
#panel label {font-weight:500;}
</style>
</head>
<body>

<h1>Club Ã“nix - Panel de Administrador</h1>

<div id="loginPanel">
  <h2>Iniciar sesiÃ³n</h2>
  <input id="loginEmail" type="email" placeholder="Correo electrÃ³nico"><br>
  <input id="loginPassword" type="password" placeholder="ContraseÃ±a"><br>
  <button onclick="login()">Iniciar sesiÃ³n</button>
  <p id="error"></p>
</div>

<div id="panel">
  <h2>Registrar deportista</h2>
  <div class="flex">
    <input id="nombre" placeholder="Nombre del deportista">
    <input id="categoria" placeholder="CategorÃ­a">
  </div>
  <h3>Datos del acudiente</h3>
  <div class="flex">
    <input id="acudienteNombre" placeholder="Nombre del acudiente">
    <input id="acudienteTelefono" placeholder="TelÃ©fono">
    <input id="acudienteCorreo" type="email" placeholder="Correo electrÃ³nico">
  </div>
  <div class="flex">
    <select id="sede">
      <option value="Pereira">Sede: Pereira</option>
      <option value="Dosquebradas">Sede: Dosquebradas</option>
    </select>
    <button id="btnGuardar" onclick="agregarDeportista()">Agregar deportista</button>
  </div>

  <h2>Lista de deportistas</h2>
  <div class="flex">
    <div>
      <label>Filtrar por pago:</label>
      <select id="filtroPago" onchange="mostrar()">
        <option value="todos">Todos</option>
        <option value="pendiente">Pendientes</option>
        <option value="pagado">Pagados</option>
      </select>
    </div>
    <div>
      <label>Buscar por nombre:</label>
      <input id="busquedaNombre" type="text" placeholder="Escribe el nombre" oninput="mostrar()">
    </div>
    <div>
      <label>Filtrar por sede:</label>
      <select id="filtroSede" onchange="mostrar()">
        <option value="todos">Todas</option>
        <option value="Pereira">Pereira</option>
        <option value="Dosquebradas">Dosquebradas</option>
      </select>
    </div>
  </div>
  <ul id="lista"></ul>

  <br>
  <button onclick="logout()">Cerrar sesiÃ³n</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDIFkhozwB5W7NYdjJlvH-EZvPlvFsOz3E",
  authDomain: "club-deportivo-de-volley-onix.firebaseapp.com",
  projectId: "club-deportivo-de-volley-onix",
  storageBucket: "club-deportivo-de-volley-onix.firebasestorage.app",
  messagingSenderId: "378193996380",
  appId: "1:378193996380:web:12c4c1cf27499e224a9499",
  measurementId: "G-Y8DL77DH3J"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let editarId = null;

// ===== AUTENTICACIÃ“N =====
async function login(){
  const email=document.getElementById("loginEmail").value;
  const password=document.getElementById("loginPassword").value;
  const error=document.getElementById("error");
  try{
    await signInWithEmailAndPassword(auth,email,password);
    error.innerText="";
  }catch(e){
    error.innerText="Correo o contraseÃ±a incorrectos";
  }
}

function logout(){ signOut(auth); }

onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("loginPanel").style.display="none";
    document.getElementById("panel").style.display="block";
    mostrar();
  }else{
    document.getElementById("loginPanel").style.display="block";
    document.getElementById("panel").style.display="none";
  }
});

// ===== FUNCIONES PRINCIPALES =====
function limpiarFormulario(){
  document.getElementById("nombre").value="";
  document.getElementById("categoria").value="";
  document.getElementById("acudienteNombre").value="";
  document.getElementById("acudienteTelefono").value="";
  document.getElementById("acudienteCorreo").value="";
  document.getElementById("sede").value="Pereira";
  document.getElementById("btnGuardar").innerText="Agregar deportista";
  editarId = null;
}

async function agregarDeportista(){
  const nombre = document.getElementById("nombre").value;
  const categoria = document.getElementById("categoria").value;
  const acudienteNombre = document.getElementById("acudienteNombre").value;
  const acudienteTelefono = document.getElementById("acudienteTelefono").value;
  const acudienteCorreo = document.getElementById("acudienteCorreo").value;
  const sede = document.getElementById("sede").value;
  if(!nombre) return;

  let deportistaData = {
    nombre,
    categoria,
    acudiente: { nombre: acudienteNombre, telefono: acudienteTelefono, correo: acudienteCorreo },
    sede
  };

  if(!editarId){
    deportistaData.pago = "Pendiente"; // Nuevo deportista
    await addDoc(collection(db,"deportistas"), deportistaData);
  } else {
    // Mantener el pago existente
    const docRef = doc(db,"deportistas",editarId);
    const docSnap = await getDocs(docRef);
    let pagoActual = "Pendiente";
    try { pagoActual = (docSnap.data().pago) || "Pendiente"; } catch(e){ }
    deportistaData.pago = pagoActual;
    await setDoc(doc(db,"deportistas",editarId), deportistaData);
  }

  mostrar();
  limpiarFormulario();
}

async function editarDeportista(id){
  const docRef = doc(db,"deportistas",id);
  const dSnap = await getDocs(docRef);
  const d = dSnap.data();
  document.getElementById("nombre").value=d.nombre;
  document.getElementById("categoria").value=d.categoria;
  document.getElementById("acudienteNombre").value=d.acudiente?.nombre||"";
  document.getElementById("acudienteTelefono").value=d.acudiente?.telefono||"";
  document.getElementById("acudienteCorreo").value=d.acudiente?.correo||"";
  document.getElementById("sede").value=d.sede||"Pereira";
  editarId=id;
  document.getElementById("btnGuardar").innerText="Guardar cambios";
}

async function borrarDeportista(id){
  if(confirm("Â¿Seguro que deseas eliminar este deportista?")){
    await deleteDoc(doc(db,"deportistas",id));
    mostrar();
  }
}

async function registrarPago(){
  const nombre=document.getElementById("pagoNombre").value;
  const monto=document.getElementById("monto").value;
  const q=query(collection(db,"deportistas"),where("nombre","==",nombre));
  const querySnapshot = await getDocs(q);
  querySnapshot.forEach(async docu => {
    await updateDoc(doc(db,"deportistas",docu.id),{pago:"Pagado $ "+monto});
  });
  mostrar();
}

function enviarWhatsApp(nombre,pago){
  const url=`https://wa.me/?text=${encodeURIComponent(`Hola ${nombre}, tu estado de pago es: ${pago}. Club Ã“nix`)}`;
  window.open(url,"_blank");
}

function enviarCorreo(nombre,pago){
  const url=`https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent("Estado de pago - Club Ã“nix")}&body=${encodeURIComponent(`Hola ${nombre}, tu estado de pago es: ${pago}.`)}`;
  window.open(url,"_blank");
}

async function mostrar(){
  const lista=document.getElementById("lista");
  const filtro=document.getElementById("filtroPago").value;
  const busqueda=document.getElementById("busquedaNombre").value.toLowerCase();
  const filtroSede=document.getElementById("filtroSede").value;
  lista.innerHTML="";
  const querySnapshot = await getDocs(collection(db,"deportistas"));
  querySnapshot.forEach(docu=>{
    const d=docu.data(); const id=docu.id;
    const clasePago=d.pago.startsWith("Pagado")?"pago-pagado":"pago-pendiente";
    if(filtro==="pendiente" && d.pago.startsWith("Pagado")) return;
    if(filtro==="pagado" && d.pago.startsWith("Pendiente")) return;
    if(!d.nombre.toLowerCase().includes(busqueda)) return;
    if(filtroSede!=="todos" && d.sede !== filtroSede) return;

    const li=document.createElement("li");
    li.className="deportista-card";
    li.innerHTML=`
      <strong>${d.nombre}</strong> - ${d.categoria} - <span class="${clasePago}">${d.pago}</span><br>
      <small>ğŸ‘¤ <strong>Acudiente:</strong> ${d.acudiente?.nombre||"-"}<br>
      ğŸ“ <strong>TelÃ©fono:</strong> ${d.acudiente?.telefono||"-"}<br>
      âœ‰ï¸ <strong>Correo:</strong> ${d.acudiente?.correo||"-"}<br>
      ğŸ« <strong>Sede:</strong> ${d.sede||"-"}</small><br>
      <button onclick="enviarWhatsApp('${d.nombre}','${d.pago}')">ğŸ“² WhatsApp</button>
      <button onclick="enviarCorreo('${d.nombre}','${d.pago}')">âœ‰ï¸ Gmail</button>
      <button onclick="editarDeportista('${id}')">âœï¸ Editar</button>
      <button class="delete-btn" onclick="borrarDeportista('${id}')">ğŸ—‘ï¸ Eliminar</button>
    `;
    lista.appendChild(li);
  });
}
</script>

</body>
</html>
