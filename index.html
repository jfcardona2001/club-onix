<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrador - Club √ìnix</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;margin:20px;}
input,select,button{padding:5px;margin:5px 0;}
ul{list-style:none;padding:0;}
.deportista-card{border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:5px;background:#f9f9f9;}
.pago-pendiente{color:red;font-weight:bold;}
.pago-pagado{color:green;font-weight:bold;}
.delete-btn{background:#dc3545;color:white;border:none;border-radius:3px;padding:5px;margin-top:5px;}
.toggle-btn{background:#007bff;color:white;border:none;border-radius:3px;padding:5px;margin-top:5px;}
#panel{display:none;}
#error{color:red;}
button{cursor:pointer;margin-right:5px;margin-top:5px;}
table{border-collapse:collapse;width:100%;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#f0f0f0;}
</style>
</head>
<body>

<h1>Club √ìnix - Panel de Administrador</h1>

<div id="loginPanel">
  <h2>Iniciar sesi√≥n</h2>
  <input id="loginEmail" type="email" placeholder="Correo electr√≥nico"><br>
  <input id="loginPassword" type="password" placeholder="Contrase√±a"><br>
  <button onclick="login()">Iniciar sesi√≥n</button>
  <p id="error"></p>
</div>

<div id="panel">
  <h2>Registrar deportista</h2>
  <input id="nombre" placeholder="Nombre del deportista">
  <input id="categoria" placeholder="Categor√≠a"><br>
  <label>Sede:</label>
  <select id="sede">
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select><br>
  <h3>Datos del acudiente</h3>
  <input id="acudienteNombre" placeholder="Nombre del acudiente">
  <input id="acudienteTelefono" placeholder="Tel√©fono">
  <input id="acudienteCorreo" type="email" placeholder="Correo electr√≥nico"><br>
  <button id="btnGuardar" onclick="agregarDeportista()">Agregar deportista</button>

  <h2>Lista de deportistas</h2>
  <label>Filtrar por sede: </label>
  <select id="filtroSede" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="Pereira">Pereira</option>
    <option value="Dosquebradas">Dosquebradas</option>
  </select>
  <br>
  <label>Filtrar por pago: </label>
  <select id="filtroPago" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="pendiente">Pendientes</option>
    <option value="pagado">Pagados</option>
  </select>
  <br>
  <label>Filtrar por mes: </label>
  <select id="filtroMes" onchange="mostrar()">
    <option value="todos">Todos</option>
    <option value="1">Enero</option>
    <option value="2">Febrero</option>
    <option value="3">Marzo</option>
    <option value="4">Abril</option>
    <option value="5">Mayo</option>
    <option value="6">Junio</option>
    <option value="7">Julio</option>
    <option value="8">Agosto</option>
    <option value="9">Septiembre</option>
    <option value="10">Octubre</option>
    <option value="11">Noviembre</option>
    <option value="12">Diciembre</option>
  </select>
  <br>
  <label>Filtrar por a√±o: </label>
  <select id="filtroAnio" onchange="mostrar()">
    <option value="todos">Todos</option>
  </select>
  <br>
  <label>Buscar por nombre: </label>
  <input id="busquedaNombre" type="text" placeholder="Escribe el nombre" oninput="mostrar()">
  <ul id="lista"></ul>

  <h2>Resumen de pagos por sede</h2>
  <table id="resumenPagos">
    <thead>
      <tr>
        <th>Sede</th>
        <th>Total Deportistas</th>
        <th>Pendientes</th>
        <th>Pagados</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <br>
  <button onclick="exportarPDF()">üìÑ Exportar PDF profesional</button>
  <br><br>
  <button onclick="logout()">Cerrar sesi√≥n</button>
</div>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDIFkhozwB5W7NYdjJlvH-EZvPlvFsOz3E",
  authDomain: "club-deportivo-de-volley-onix.firebaseapp.com",
  projectId: "club-deportivo-de-volley-onix",
  storageBucket: "club-deportivo-de-volley-onix.firebasestorage.app",
  messagingSenderId: "378193996380",
  appId: "1:378193996380:web:12c4c1cf27499e224a9499",
  measurementId: "G-Y8DL77DH3J"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let editarId = null;

// ===== LOGIN =====
async function login(){
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const error = document.getElementById("error");
  try {
    await auth.signInWithEmailAndPassword(email,password);
    error.innerText="";
  } catch(e) {
    error.innerText="Correo o contrase√±a incorrectos";
  }
}

function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById("loginPanel").style.display="none";
    document.getElementById("panel").style.display="block";
    actualizarFiltrosAnio();
    mostrar();
  } else {
    document.getElementById("loginPanel").style.display="block";
    document.getElementById("panel").style.display="none";
  }
});

// ===== FUNCIONES DE DEPORTISTAS =====
function limpiarFormulario(){
  document.getElementById("nombre").value="";
  document.getElementById("categoria").value="";
  document.getElementById("sede").value="Pereira";
  document.getElementById("acudienteNombre").value="";
  document.getElementById("acudienteTelefono").value="";
  document.getElementById("acudienteCorreo").value="";
  document.getElementById("btnGuardar").innerText="Agregar deportista";
  editarId = null;
}

async function agregarDeportista(){
  const nombre = document.getElementById("nombre").value;
  const categoria = document.getElementById("categoria").value;
  const sede = document.getElementById("sede").value;
  const acudienteNombre = document.getElementById("acudienteNombre").value;
  const acudienteTelefono = document.getElementById("acudienteTelefono").value;
  const acudienteCorreo = document.getElementById("acudienteCorreo").value;
  if(!nombre) return;

  const deportistaData = {
    nombre,
    categoria,
    sede,
    pago:"Pendiente",
    fechaPago: null,
    acudiente:{nombre:acudienteNombre,telefono:acudienteTelefono,correo:acudienteCorreo}
  };

  if(!editarId){
    await db.collection("deportistas").add(deportistaData);
  } else {
    await db.collection("deportistas").doc(editarId).set(deportistaData);
  }

  limpiarFormulario();
  actualizarFiltrosAnio();
  mostrar();
}

async function editarDeportista(id){
  const docRef = db.collection("deportistas").doc(id);
  const docSnap = await docRef.get();
  if(docSnap.exists){
    const d = docSnap.data();
    document.getElementById("nombre").value = d.nombre;
    document.getElementById("categoria").value = d.categoria;
    document.getElementById("sede").value = d.sede || "Pereira";
    document.getElementById("acudienteNombre").value = d.acudiente?.nombre || "";
    document.getElementById("acudienteTelefono").value = d.acudiente?.telefono || "";
    document.getElementById("acudienteCorreo").value = d.acudiente?.correo || "";
    editarId = id;
    document.getElementById("btnGuardar").innerText="Guardar cambios";
  }
}

async function borrarDeportista(id){
  if(confirm("¬øSeguro que deseas eliminar este deportista?")){
    await db.collection("deportistas").doc(id).delete();
    actualizarFiltrosAnio();
    mostrar();
  }
}

async function togglePago(id){
  const docRef = db.collection("deportistas").doc(id);
  const docSnap = await docRef.get();
  if(docSnap.exists){
    const d = docSnap.data();
    if(d.pago.startsWith("Pendiente")){
      const monto = prompt("Ingrese el monto pagado (COP):","0");
      if(monto === null) return;
      const fecha = new Date();
      await docRef.update({
        pago:`Pagado $ ${monto}`,
        fechaPago:{mes:fecha.getMonth()+1,anio:fecha.getFullYear()}
      });
    } else {
      await docRef.update({pago:"Pendiente", fechaPago:null});
    }
    mostrar();
  }
}

async function actualizarFiltrosAnio(){
  const snapshot = await db.collection("deportistas").get();
  const anios = new Set();
  snapshot.forEach(docu=>{
    const d = docu.data();
    if(d.fechaPago) anios.add(d.fechaPago.anio);
  });

  const filtroAnio = document.getElementById("filtroAnio");
  filtroAnio.innerHTML = '<option value="todos">Todos</option>';
  Array.from(anios).sort((a,b)=>a-b).forEach(a=>{
    const opt = document.createElement("option");
    opt.value = a;
    opt.text = a;
    filtroAnio.appendChild(opt);
  });
}

async function mostrar(){
  const lista = document.getElementById("lista");
  const filtroPago = document.getElementById("filtroPago").value;
  const filtroSede = document.getElementById("filtroSede").value;
  const filtroMes = document.getElementById("filtroMes").value;
  const filtroAnio = document.getElementById("filtroAnio").value;
  const busqueda = document.getElementById("busquedaNombre").value.toLowerCase();
  lista.innerHTML="";

  const resumen = {Pereira:{total:0,pendientes:0,pagados:0}, Dosquebradas:{total:0,pendientes:0,pagados:0}};

  const snapshot = await db.collection("deportistas").get();
  snapshot.forEach(docu=>{
    const d = docu.data();
    const id = docu.id;
    const clasePago = d.pago.startsWith("Pagado")?"pago-pagado":"pago-pendiente";

    if(resumen[d.sede]){
      resumen[d.sede].total++;
      if(d.pago.startsWith("Pagado")) resumen[d.sede].pagados++;
      else resumen[d.sede].pendientes++;
    }

    if(filtroPago==="pendiente" && d.pago.startsWith("Pagado")) return;
    if(filtroPago==="pagado" && d.pago.startsWith("Pendiente")) return;
    if(filtroSede !== "todos" && d.sede !== filtroSede) return;
    if(filtroMes !== "todos" && (!d.fechaPago || d.fechaPago.mes != filtroMes)) return;
    if(filtroAnio !== "todos" && (!d.fechaPago || d.fechaPago.anio != filtroAnio)) return;
    if(!d.nombre.toLowerCase().includes(busqueda)) return;

    const li = document.createElement("li");
    li.className="deportista-card";
    li.innerHTML = `
      <strong>${d.nombre}</strong> - ${d.categoria} - ${d.sede} - <span class="${clasePago}">${d.pago}</span><br>
      üë§ <strong>Acudiente:</strong> ${d.acudiente?.nombre || "-"}<br>
      üìû <strong>Tel√©fono:</strong> ${d.acudiente?.telefono || "-"}<br>
      ‚úâÔ∏è <strong>Correo:</strong> ${d.acudiente?.correo || "-"}<br>
      <button onclick="editarDeportista('${id}')">‚úèÔ∏è Editar</button>
      <button class="delete-btn" onclick="borrarDeportista('${id}')">üóëÔ∏è Eliminar</button>
      <button class="toggle-btn" onclick="togglePago('${id}')">üíµ Cambiar estado de pago</button>
    `;
    lista.appendChild(li);
  });

  const tbody = document.querySelector("#resumenPagos tbody");
  tbody.innerHTML = "";
  for(const sede in resumen){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${sede}</td>
      <td>${resumen[sede].total}</td>
      <td>${resumen[sede].pendientes}</td>
      <td>${resumen[sede].pagados}</td>
    `;
    tbody.appendChild(tr);
  }
}

// ===== EXPORTAR PDF PROFESIONAL =====
async function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const snapshot = await db.collection("deportistas").get();
  
  // Agrupar por categor√≠a y sede
  const categorias = {};
  snapshot.forEach(docu=>{
    const d = docu.data();
    if(!categorias[d.categoria]) categorias[d.categoria] = {};
    if(!categorias[d.categoria][d.sede]) categorias[d.categoria][d.sede] = [];
    categorias[d.categoria][d.sede].push(d);
  });

  let y = 10;
  doc.setFontSize(16);
  doc.text("Club √ìnix - Deportistas por Categor√≠a y Sede", 10, y); y+=10;

  for(const cat in categorias){
    doc.setFontSize(14);
    doc.text(`Categor√≠a: ${cat}`,10,y); y+=7;
    for(const sede in categorias[cat]){
      doc.setFontSize(12);
      doc.text(`Sede: ${sede}`,12,y); y+=6;

      const rows = categorias[cat][sede].map(d=>{
        return [
          d.nombre,
          d.pago.startsWith("Pagado") ? "Pagado" : "Pendiente",
          d.acudiente?.nombre||"-",
          d.acudiente?.telefono||"-",
          d.acudiente?.correo||"-"
        ];
      });

      doc.autoTable({
        startY: y,
        head:[["Nombre","Pago","Acudiente","Tel√©fono","Correo"]],
        body: rows,
        theme:'grid',
        headStyles:{fillColor:[200,200,200]},
        didDrawCell: function(data){
          if(data.column.index === 1 && data.cell.section === 'body'){
            const pago = data.cell.text[0];
            if(pago === "Pagado"){
              data.cell.styles.textColor = [0,128,0]; // verde
            } else {
              data.cell.styles.textColor = [255,0,0]; // rojo
            }
          }
        }
      });
      y = doc.lastAutoTable.finalY + 10;
      if(y>280){ doc.addPage(); y=10; }
    }
  }

  doc.save("deportistas_profesional.pdf");
}
</script>

</body>
</html>
